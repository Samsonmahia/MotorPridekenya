<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotorPride | All Cars</title>
    <style>
        /* Your existing CSS remains the same */
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #f8f9fa;
            --accent-color: #ff6b35;
            --text-color: #333;
            --light-text: #666;
            --border-color: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Your existing CSS styles remain the same */
        /* ... (all your CSS styles) ... */

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">motorpride</div>
                <nav>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="#" class="active">All Cars</a></li>
                        <li><a href="aboutus.html">About</a></li>
                        <li><a href="contacts.html">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="container">
        <h1 class="page-title">Our Vehicle Collection</h1>
        
        <div class="debug-info" id="debugInfo">
            <div class="loading-spinner"></div>
            <span>Initializing car catalog...</span>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div class="cars-grid" id="carsGrid">
            <div class="no-results">
                <div class="no-results-icon">üîÑ</div>
                <h3 class="no-results-title">Loading Vehicles...</h3>
                <p class="no-results-text">Please wait while we load our vehicle collection.</p>
            </div>
        </div>
        
        <div class="pagination" id="pagination" style="display: none;">
            <button id="prevPage" disabled>Previous</button>
            <div class="page-numbers">
                <span id="currentPage">1</span> / <span id="totalPages">1</span>
            </div>
            <button id="nextPage">Next</button>
        </div>
    </main>

    <!-- Your modals remain the same -->
    <div class="modal-overlay" id="carModal">
        <!-- ... modal content ... -->
    </div>

    <div class="contacts-modal" id="contactsModal">
        <!-- ... contacts modal content ... -->
    </div>

    <script>
    // Configuration with optimized values
    const CONFIG = {
        carsPerPage: 12,
        maxThumbnails: 4, // Reduced for better performance
        animationDelay: 50,
        batchSize: 5, // Process files in smaller batches
        timeout: 30000, // 30 second timeout
        retryAttempts: 2
    };

    // State management
    const state = {
        cars: [],
        contacts: [],
        currentPage: 1,
        currentCarIndex: 0,
        totalPages: 1,
        isLoading: false,
        loadedFiles: 0,
        totalFiles: 0
    };

    // DOM Elements
    const elements = {
        carsGrid: document.getElementById('carsGrid'),
        carModal: document.getElementById('carModal'),
        contactsModal: document.getElementById('contactsModal'),
        closeModal: document.getElementById('closeModal'),
        closeContacts: document.getElementById('closeContacts'),
        prevPage: document.getElementById('prevPage'),
        nextPage: document.getElementById('nextPage'),
        currentPageEl: document.getElementById('currentPage'),
        totalPagesEl: document.getElementById('totalPages'),
        prevCar: document.getElementById('prevCar'),
        nextCar: document.getElementById('nextCar'),
        modalReserveBtn: document.getElementById('modalReserveBtn'),
        debugInfo: document.getElementById('debugInfo'),
        modalCarTitle: document.getElementById('modalCarTitle'),
        modalPrimaryImage: document.getElementById('modalPrimaryImage'),
        modalThumbnails: document.getElementById('modalThumbnails'),
        carDetails: document.getElementById('carDetails'),
        contactsList: document.getElementById('contactsList'),
        progressFill: document.getElementById('progressFill'),
        pagination: document.getElementById('pagination')
    };

    // Utility functions
    const utils = {
        updateProgress(percentage) {
            if (elements.progressFill) {
                elements.progressFill.style.width = `${percentage}%`;
            }
        },

        updateDebugInfo(message) {
            if (elements.debugInfo) {
                elements.debugInfo.innerHTML = `<div class="loading-spinner"></div><span>${message}</span>`;
            }
            console.log(`DEBUG: ${message}`);
        },

        showLoadingState() {
            elements.carsGrid.innerHTML = `
                <div class="no-results">
                    <div class="no-results-icon">üîÑ</div>
                    <h3 class="no-results-title">Loading Vehicles...</h3>
                    <p class="no-results-text">Please wait while we load our vehicle collection.</p>
                </div>
            `;
        },

        showErrorState(message = 'Temporary Unavailable') {
            elements.carsGrid.innerHTML = `
                <div class="no-results">
                    <div class="no-results-icon">‚ö†Ô∏è</div>
                    <h3 class="no-results-title">${message}</h3>
                    <p class="no-results-text">Our vehicle catalog is currently being updated. Please check back shortly.</p>
                    <button class="browse-all" onclick="location.reload()">Try Again</button>
                </div>
            `;
        },

        formatWhatsAppNumber(number) {
            return number.replace(/\s+/g, '').replace(/-/g, '');
        },

        // Debounce function to limit API calls
        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    };

    // OPTIMIZED Data management
    const dataManager = {
        async loadCarsData() {
            if (state.isLoading) return;
            state.isLoading = true;

            try {
                utils.updateDebugInfo('Scanning for car files...');
                
                // Use timeout to prevent hanging
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Load timeout')), CONFIG.timeout)
                );

                const loadPromise = this.loadCarsWithFallback();
                
                const carFiles = await Promise.race([loadPromise, timeoutPromise]);
                
                if (carFiles.length === 0) {
                    utils.updateDebugInfo('No car files found - using fallback data');
                    await this.loadFallbackCars();
                } else {
                    state.cars = carFiles;
                    utils.updateDebugInfo(`‚úÖ Loaded ${state.cars.length} vehicles`);
                }
                
            } catch (error) {
                console.error('Error loading cars:', error);
                utils.updateDebugInfo(`Error: ${error.message}`);
                await this.loadFallbackCars();
            } finally {
                state.isLoading = false;
            }
        },

        async loadCarsWithFallback() {
            // Priority 1: Try to load from a single consolidated file first
            try {
                const consolidatedCars = await this.tryLoadConsolidatedFile();
                if (consolidatedCars.length > 0) {
                    utils.updateDebugInfo(`‚úÖ Loaded ${consolidatedCars.length} cars from consolidated file`);
                    return consolidatedCars;
                }
            } catch (error) {
                console.log('Consolidated file not available, trying individual files');
            }

            // Priority 2: Try known individual files
            const knownFiles = [
                'cx-5.json', 'mazda.json', 'mercedes-benz.json',
                'nissan-note-2025.json', 'suzuki.json', 
                'volvo-v40-t3-2025.json', 'volvo.json',
                'cars.json', 'vehicles.json', 'inventory.json' // Common consolidated names
            ];

            utils.updateDebugInfo(`Checking ${knownFiles.length} known files...`);
            return await this.loadCarFiles(knownFiles);
        },

        async tryLoadConsolidatedFile() {
            const consolidatedFiles = [
                'cars.json',
                'vehicles.json', 
                'inventory.json',
                'all-cars.json'
            ];

            for (const filename of consolidatedFiles) {
                try {
                    const response = await fetch(`./data/cars/${filename}`);
                    if (response.ok) {
                        const data = await response.json();
                        return this.normalizeCarsData(data, filename);
                    }
                } catch (error) {
                    // Continue to next file
                }
            }
            return [];
        },

        async loadCarFiles(filenames) {
            const allCars = [];
            state.totalFiles = filenames.length;
            state.loadedFiles = 0;

            // Process in smaller batches to avoid overwhelming the browser
            const batchSize = CONFIG.batchSize;
            for (let i = 0; i < filenames.length; i += batchSize) {
                const batch = filenames.slice(i, i + batchSize);
                const batchPromises = batch.map(filename => 
                    this.loadSingleCarFileWithRetry(filename)
                );

                const batchResults = await Promise.allSettled(batchPromises);
                
                batchResults.forEach(result => {
                    if (result.status === 'fulfilled' && result.value) {
                        allCars.push(...result.value);
                    }
                });

                state.loadedFiles += batch.length;
                const progress = (state.loadedFiles / state.totalFiles) * 100;
                utils.updateProgress(progress);
                utils.updateDebugInfo(`Loading cars... ${Math.round(progress)}%`);
                
                // Small delay between batches to prevent UI blocking
                await this.delay(100);
            }

            // Remove duplicates based on ID
            return this.removeDuplicates(allCars);
        },

        async loadSingleCarFileWithRetry(filename, attempt = 0) {
            try {
                return await this.loadSingleCarFile(filename);
            } catch (error) {
                if (attempt < CONFIG.retryAttempts) {
                    console.log(`Retrying ${filename}, attempt ${attempt + 1}`);
                    await this.delay(500 * (attempt + 1));
                    return this.loadSingleCarFileWithRetry(filename, attempt + 1);
                }
                throw error;
            }
        },

        async loadSingleCarFile(filename) {
            try {
                const response = await fetch(`./data/cars/${filename}`);
                if (!response.ok) {
                    return null;
                }
                
                const carData = await response.json();
                return this.normalizeCarsData(carData, filename);
            } catch (error) {
                console.warn(`Failed to load ${filename}:`, error);
                return null;
            }
        },

        normalizeCarsData(carData, filename) {
            let carsArray = [];

            // Handle different data formats
            if (Array.isArray(carData)) {
                carsArray = carData;
            } else if (carData.cars && Array.isArray(carData.cars)) {
                carsArray = carData.cars;
            } else if (typeof carData === 'object') {
                carsArray = [carData];
            }

            return carsArray.map(car => this.normalizeCarData(car, filename));
        },

        normalizeCarData(car, filename) {
            // Create a unique ID if not present
            if (!car.id) {
                car.id = `${filename}-${car.name ? car.name.replace(/\s+/g, '-').toLowerCase() : Date.now()}`;
            }

            // Ensure required fields
            if (!car.name) {
                if (car.make && car.model) {
                    car.name = `${car.make} ${car.model}`;
                } else if (car.title) {
                    car.name = car.title;
                } else {
                    car.name = `Vehicle from ${filename.replace('.json', '')}`;
                }
            }

            // Handle images - ensure array exists and has proper paths
            if (!car.images || !Array.isArray(car.images) || car.images.length === 0) {
                car.images = ['/images/cars/placeholder.jpg'];
            } else {
                car.images = car.images.map(img => {
                    if (img.startsWith('http') || img.startsWith('/')) {
                        return img;
                    } else {
                        return `/images/cars/${img}`;
                    }
                });
            }

            // Set defaults for missing fields
            const defaults = {
                price: 'Contact for price',
                year: new Date().getFullYear(),
                transmission: 'Automatic',
                fuel: 'Petrol',
                mileage: '0 km',
                status: 'Available',
                make: car.make || 'Unknown',
                model: car.model || 'Unknown'
            };

            Object.keys(defaults).forEach(key => {
                if (!car[key]) car[key] = defaults[key];
            });

            return car;
        },

        removeDuplicates(cars) {
            const seen = new Set();
            return cars.filter(car => {
                const identifier = car.id || `${car.name}-${car.year}`;
                if (seen.has(identifier)) {
                    return false;
                }
                seen.add(identifier);
                return true;
            });
        },

        async loadFallbackCars() {
            utils.updateDebugInfo('Loading sample vehicles...');
            // Provide fallback data if CMS is down
            state.cars = [
                {
                    id: 'fallback-1',
                    name: 'Mazda CX-5',
                    year: 2024,
                    price: '$32,000',
                    transmission: 'Automatic',
                    fuel: 'Petrol',
                    mileage: '15,000 km',
                    status: 'Available',
                    images: ['/images/cars/placeholder.jpg'],
                    make: 'Mazda',
                    model: 'CX-5'
                },
                {
                    id: 'fallback-2',
                    name: 'Toyota RAV4',
                    year: 2024,
                    price: '$35,000',
                    transmission: 'Automatic',
                    fuel: 'Hybrid',
                    mileage: '10,000 km',
                    status: 'Available',
                    images: ['/images/cars/placeholder.jpg'],
                    make: 'Toyota',
                    model: 'RAV4'
                }
            ];
            utils.updateDebugInfo(`‚úÖ Loaded ${state.cars.length} sample vehicles`);
        },

        async loadContactsData() {
            try {
                const contactFiles = ['kiarie.json', 'sam.json'];
                const contactPromises = contactFiles.map(filename =>
                    fetch(`./data/contacts/${filename}`)
                        .then(response => response.ok ? response.json() : null)
                        .catch(() => null)
                );
                
                const contactData = await Promise.all(contactPromises);
                state.contacts = contactData.filter(contact => contact !== null);
                
                if (state.contacts.length === 0) {
                    state.contacts = [
                        { name: "Sales Team", number: "+254712345678" },
                        { name: "Support Team", number: "+254798765432" }
                    ];
                }
            } catch (error) {
                state.contacts = [
                    { name: "Sales Team", number: "+254712345678" },
                    { name: "Support Team", number: "+254798765432" }
                ];
            }
        },

        delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    };

    // UI rendering (optimized)
    const renderer = {
        displayCars() {
            if (state.cars.length === 0) {
                utils.showErrorState('No vehicles available');
                return;
            }

            const startIndex = (state.currentPage - 1) * CONFIG.carsPerPage;
            const endIndex = startIndex + CONFIG.carsPerPage;
            const currentCars = state.cars.slice(startIndex, endIndex);
            
            elements.carsGrid.innerHTML = '';
            
            currentCars.forEach(car => {
                const carCard = this.createCarCard(car);
                elements.carsGrid.appendChild(carCard);
            });
            
            this.setupPagination();
            elements.pagination.style.display = 'flex';
        },

        createCarCard(car) {
            const statusClass = car.status ? `status-${car.status.toLowerCase().replace(' ', '-')}` : '';
            const primaryImage = car.images[0];
            const carName = car.name.length > 30 ? car.name.substring(0, 30) + '...' : car.name;
            
            const carCard = document.createElement('div');
            carCard.className = 'car-card';
            carCard.innerHTML = `
                <div class="car-image-container" data-car-id="${car.id}">
                    ${car.status ? `<div class="status-badge ${statusClass}">${car.status}</div>` : ''}
                    <img src="${primaryImage}" alt="${car.name}" class="car-image" loading="lazy" onerror="this.src='/images/cars/placeholder.jpg'">
                    <button class="reserve-btn">Reserve</button>
                </div>
                <div class="car-info">
                    <div class="car-name">${carName}</div>
                    <div class="car-year-price">
                        <span>${car.year}</span>
                        <span class="car-price">${car.price}</span>
                    </div>
                    <div class="car-specs">
                        <span>${car.transmission}</span>
                        <span>${car.fuel}</span>
                        <span>${car.mileage}</span>
                    </div>
                </div>
            `;
            
            // Attach event listeners
            const container = carCard.querySelector('.car-image-container');
            const reserveBtn = carCard.querySelector('.reserve-btn');
            
            container.addEventListener('click', (e) => {
                if (!e.target.classList.contains('reserve-btn')) {
                    modalManager.openCarModal(car.id);
                }
            });
            
            reserveBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                modalManager.openContactsModal();
            });
            
            return carCard;
        },

        setupPagination() {
            state.totalPages = Math.max(1, Math.ceil(state.cars.length / CONFIG.carsPerPage));
            elements.currentPageEl.textContent = state.currentPage;
            elements.totalPagesEl.textContent = state.totalPages;
            elements.prevPage.disabled = state.currentPage === 1;
            elements.nextPage.disabled = state.currentPage === state.totalPages;
        }
    };

    // Modal management (same as before)
    const modalManager = {
        // ... your existing modal manager code ...
    };

    // Event handlers (same as before)
    const eventHandlers = {
        // ... your existing event handlers code ...
    };

    // Main application
    const app = {
        async init() {
            try {
                utils.showLoadingState();
                
                // Load contacts first (usually smaller and faster)
                await dataManager.loadContactsData();
                
                // Then load cars
                await dataManager.loadCarsData();
                
                // Hide debug info after successful load
                setTimeout(() => {
                    elements.debugInfo.style.display = 'none';
                }, 2000);
                
                renderer.displayCars();
                eventHandlers.setupPaginationEvents();
                eventHandlers.setupModalEvents();
                
            } catch (error) {
                console.error('Error initializing page:', error);
                utils.showErrorState();
            }
        }
    };

    // Initialize with error handling
    document.addEventListener('DOMContentLoaded', () => {
        // Add error boundary
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            utils.showErrorState();
        });

        // Initialize app
        app.init().catch(error => {
            console.error('Failed to initialize app:', error);
            utils.showErrorState();
        });
    });
    </script>
</body>
</html>